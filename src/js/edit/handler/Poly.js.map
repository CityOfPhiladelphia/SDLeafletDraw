{"version":3,"sources":["../../../es6/edit/handler/Poly.js"],"names":[],"mappings":"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","file":"Poly.js","sourcesContent":["/** @flow\n * StratoDem Analytics : Poly\n * Principal Author(s) : Michael Clawar\n * Secondary Author(s) :\n * Description :\n *\n *  (c) 2016- StratoDem Analytics, LLC\n *  All Rights Reserved\n */\n\nimport L from 'leaflet';\n\nimport { TouchMarker } from '../../ext/index';\nimport drawLocal from '../../draw';\nimport Event from '../../Event';\n\n/** Poly **/\nexport class Poly extends L.Handler {\n  static options = {};\n\n  initialize(poly: L.Layer, options: {}): void {\n    this.latlngs = [poly._latlngs];\n    if (poly._holes) {\n      this.latlngs = this.latlngs.concat(poly._holes);\n    }\n\n    this._poly = poly;\n    L.setOptions(this, options);\n\n    this._poly.on('revert-edited', this._updateLatLngs, this);\n  }\n\n  /** Compatibility method to normalize Poly* objects between 0.7.x and 1.0+ **/\n  _defaultShape(): L.Polyline {\n    if (!L.Polyline._flat)\n      return this._poly._latlngs;\n\n    return L.Polyline._flat(this._poly._latlngs)\n      ? this._poly._latlngs\n      : this._poly._latlngs[0];\n  }\n\n  _eachVertexHandler(callback: (any) => void): void {\n    this._verticesHandlers.forEach(vh => callback(vh));\n  }\n\n  /** Add listener hooks to this handler **/\n  addHooks(): void {\n    this._initHandlers();\n    this._eachVertexHandler((handler) => {\n      handler.addHooks();\n    });\n  }\n\n  /** Remove listener hooks from this handler **/\n  removeHooks(): void {\n    this._eachVertexHandler((handler) => {\n      handler.removeHooks();\n    });\n  }\n\n  /** Fire and update for each vertex handler **/\n  updateMarkers(): void {\n    this._eachVertexHandler((handler) => {\n      handler.updateMarkers();\n    });\n  }\n\n  _initHandlers(): void {\n    this._verticesHandlers = this.latlngs  // eslint-disable-next-line\n      .map(ll => new PolyVerticesEdit(this._poly, ll, this.options));\n  }\n\n  _updateLatLngs(event: { layer: { _latlngs: Array<L.LatLng> }, _holes: Array<Object> }): void {\n    this.latlngs = [event.layer._latlngs];\n    if (event.layer._holes) {\n      this.latlngs = this.latlngs.concat(event.layer._holes);\n    }\n  }\n}\n\n\n/** PolyVerticesEdit **/\ntype T_ORIGINAL_EVENT = {\n  clientX: number,\n  clientY: number,\n  latlng: L.LatLng,\n  touches: Array<{clientX: number, clientY: number}>,\n};\ntype T_POLYVERTICES_OPTIONS = {\n  icon?: L.DivIcon,\n  touchIcon?: L.DivIcon,\n  drawError?: {\n    color?: string,\n    timeout?: number,\n  },\n};\nconst DEFAULT_POLYVERTICES_OPTIONS: T_POLYVERTICES_OPTIONS = {\n  icon: new L.DivIcon({\n    iconSize: new L.Point(8, 8),\n    className: 'leaflet-div-icon leaflet-editing-icon',\n  }),\n  touchIcon: new L.DivIcon({\n    iconSize: new L.Point(20, 20),\n    className: 'leaflet-div-icon leaflet-editing-icon leaflet-touch-icon',\n  }),\n  drawError: {\n    color: '#b00b00',\n    timeout: 1000,\n  },\n};\n\nexport class PolyVerticesEdit extends L.Handler {\n  _poly: L.Layer;\n  _latlngs: Array<L.LatLng>;\n\n  static options = DEFAULT_POLYVERTICES_OPTIONS;\n\n  initialize(poly: L.Layer, latlngs: Array<L.LatLng>, options: T_POLYVERTICES_OPTIONS): void {\n    this._poly = poly;\n    this._latlngs = latlngs;\n\n    // if touch, switch to touch icon\n    const defaultIcon = L.Browser.touch\n      ? PolyVerticesEdit.options.touchIcon\n      : PolyVerticesEdit.options.icon;\n    L.setOptions(this, {\n      icon: typeof options.icon !== 'undefined'\n        ? options.icon\n        : defaultIcon,\n      touchIcon: typeof options.touchIcon !== 'undefined'\n        ? options.touchIcon\n        : PolyVerticesEdit.options.touchIcon,\n      drawError: {\n        ...PolyVerticesEdit.options.drawError,\n        ...typeof options.drawError !== 'undefined'\n          ? options.drawError\n          : {},\n      },\n    });\n  }\n\n  /** Compatibility method to normalize Poly* objects between 0.7.x and 1.0+ **/\n  _defaultShape(): Array<L.LatLng> {\n    if (typeof L.LineUtil._flat === 'undefined')\n      return this._latlngs;\n\n    return L.LineUtil._flat(this._latlngs)\n      ? this._latlngs\n      : this._latlngs[0];\n  }\n\n  /** Add listener hooks to this handler **/\n  addHooks(): void {\n    const poly = this._poly;\n\n    if (!(poly instanceof L.Polygon)) {\n      poly.options.fill = false;\n      if (poly.options.editing) {\n        poly.options.editing.fill = false;\n      }\n    }\n\n    poly.setStyle(poly.options.editing);\n\n    if (this._poly._map) {\n      this._map = this._poly._map; // Set map\n\n      if (!this._markerGroup)\n        this._initMarkers();\n\n      this._poly._map.addLayer(this._markerGroup);\n    }\n  }\n\n  /** Remove listener hooks from this handler **/\n  removeHooks(): void {\n    const poly = this._poly;\n\n    poly.setStyle(poly.options.original);\n\n    if (poly._map) {\n      poly._map.removeLayer(this._markerGroup);\n      delete this._markerGroup;\n      delete this._markers;\n    }\n  }\n\n  /** Clear markers and update their location **/\n  updateMarkers(): void {\n    this._markerGroup.clearLayers();\n    this._initMarkers();\n  }\n\n  _initMarkers(): void {\n    if (!this._markerGroup)\n      this._markerGroup = new L.LayerGroup();\n\n    this._markers = this._defaultShape().map((ll, idx) => {\n      const marker = this._createMarker(ll, idx);\n      marker.on('click', this._onMarkerClick, this);\n      return marker;\n    });\n\n    this._markers.forEach((markerRight, idxRight) => {\n      if (!(idxRight === 0 && !(L.Polygon && (this._poly instanceof L.Polygon)))) {\n        const idxLeft = idxRight === 0 ? this._markers.length - 1 : idxRight - 1;\n        const markerLeft = this._markers[idxLeft];\n\n        this._createMiddleMarker(markerLeft, markerRight);\n        PolyVerticesEdit._updatePrevNext(markerLeft, markerRight);\n      }\n    });\n  }\n\n  _createMarker(latlng: L.LatLng, index?: number): TouchMarker {\n    // Extending L.Marker in TouchEvents.js to include touch.\n    const marker = new TouchMarker(latlng, {\n      draggable: true,\n      icon: this.options.icon,\n    });\n\n    marker._origLatLng = latlng;\n    marker._index = index;\n\n    marker\n      .on('dragstart', this._onMarkerDragStart, this)\n      .on('drag', this._onMarkerDrag, this)\n      .on('dragend', this._fireEdit, this)\n      .on('touchmove', this._onTouchMove, this)\n      .on('touchend', this._fireEdit, this)\n      .on('MSPointerMove', this._onTouchMove, this)\n      .on('MSPointerUp', this._fireEdit, this);\n\n    this._markerGroup.addLayer(marker);\n\n    return marker;\n  }\n\n  _onMarkerDragStart(): void {\n    this._poly.fire('editstart');\n  }\n\n  _spliceLatLngs(idx1: number, idx2: number, latlng: ?L.LatLng): Array<L.LatLng> {\n    const latlngs = this._defaultShape();\n    const removed = latlngs.splice(idx1, idx2, latlng);\n    this._poly._convertLatLngs(latlngs, true);\n    this._poly.redraw();\n    return removed;\n  }\n\n  _removeMarker(marker: L.Marker): void {\n    const i = marker._index;\n\n    this._markerGroup.removeLayer(marker);\n    this._markers.splice(i, 1);\n    this._spliceLatLngs(i, 1);\n    this._updateIndexes(i, -1);\n\n    marker\n      .off('dragstart', this._onMarkerDragStart, this)\n      .off('drag', this._onMarkerDrag, this)\n      .off('dragend', this._fireEdit, this)\n      .off('touchmove', this._onMarkerDrag, this)\n      .off('touchend', this._fireEdit, this)\n      .off('click', this._onMarkerClick, this)\n      .off('MSPointerMove', this._onTouchMove, this)\n      .off('MSPointerUp', this._fireEdit, this);\n  }\n\n  _fireEdit(): void {\n    this._poly.edited = true;\n    this._poly.fire('edit');\n    this._poly._map.fire(Event.EDITVERTEX, { layers: this._markerGroup, poly: this._poly });\n  }\n\n  _onMarkerDrag(event: {target: L.Marker}): void {\n    const marker = event.target;\n    const poly = this._poly;\n\n    L.extend(marker._origLatLng, marker._latlng);\n\n    if (marker._middleLeft)\n      marker._middleLeft.setLatLng(this._getMiddleLatLng(marker._prev, marker));\n    if (marker._middleRight)\n      marker._middleRight.setLatLng(this._getMiddleLatLng(marker, marker._next));\n\n    if (poly.options.poly) {\n      const tooltip = poly._map._editTooltip; // Access the tooltip\n\n      // If we don't allow intersections and the polygon intersects\n      if (!poly.options.poly.allowIntersection && poly.intersects()) {\n        const originalColor = poly.options.color;\n        poly.setStyle({ color: this.options.drawError.color });\n\n        // Manually trigger 'dragend' behavior on marker we are about to remove\n        // WORKAROUND: introduced in 1.0.0-rc2, may be related to #4484\n        if (L.version.indexOf('0.7') !== 0)\n          marker.dragging._draggable._onUp(event);\n\n        this._onMarkerClick(event); // Remove violating marker\n        // FIXME: Reset the marker to it's original position (instead of remove)\n\n        if (tooltip) {\n          tooltip.updateContent({\n            text: drawLocal.draw.handlers.polyline.error,\n          });\n        }\n\n        // Reset everything back to normal after a second\n        setTimeout(() => {\n          poly.setStyle({ color: originalColor });\n          if (tooltip) {\n            tooltip.updateContent({\n              text: drawLocal.edit.handlers.edit.tooltip.text,\n              subtext: drawLocal.edit.handlers.edit.tooltip.subtext,\n            });\n          }\n        }, 1000);\n      }\n    }\n\n    this._poly.redraw();\n    this._poly.fire('editdrag');\n  }\n\n  _onMarkerClick(event: {target: L.Marker}): void {\n    const minPoints = L.Polygon && (this._poly instanceof L.Polygon) ? 4 : 3;\n    const marker = event.target;\n\n    // If removing this point would create an invalid polyline/polygon don't remove\n    if (this._defaultShape().length < minPoints)\n      return;\n\n    // remove the marker\n    this._removeMarker(marker);\n\n    // update prev/next links of adjacent markers\n    PolyVerticesEdit._updatePrevNext(marker._prev, marker._next);\n\n    // remove ghost markers near the removed marker\n    if (marker._middleLeft) {\n      this._markerGroup.removeLayer(marker._middleLeft);\n    }\n    if (marker._middleRight) {\n      this._markerGroup.removeLayer(marker._middleRight);\n    }\n\n    // create a ghost marker in place of the removed one\n    if (marker._prev && marker._next)\n      this._createMiddleMarker(marker._prev, marker._next);\n    else if (!marker._prev)\n      marker._next._middleLeft = null;\n    else if (!marker._next)\n      marker._prev._middleRight = null;\n\n    this._fireEdit();\n  }\n\n  _onTouchMove(event: {target: L.Marker, originalEvent: T_ORIGINAL_EVENT}): void {\n    const layerPoint = this._map.mouseEventToLayerPoint(event.originalEvent.touches[0]);\n    const latlng = this._map.layerPointToLatLng(layerPoint);\n    const marker = event.target;\n\n    L.extend(marker._origLatLng, latlng);\n\n    if (marker._middleLeft)\n      marker._middleLeft.setLatLng(this._getMiddleLatLng(marker._prev, marker));\n    if (marker._middleRight)\n      marker._middleRight.setLatLng(this._getMiddleLatLng(marker, marker._next));\n\n    this._poly.redraw();\n    this.updateMarkers();\n  }\n\n  _updateIndexes(index: number, delta: number) {\n    this._markerGroup.eachLayer((marker) => {\n      if (marker._index > index) // eslint-disable-next-line\n        marker._index += delta; // TODO no reassignment\n    });\n  }\n\n  _createMiddleMarker(marker1: L.Marker, marker2: L.Marker): void {\n    const latlng = this._getMiddleLatLng(marker1, marker2);\n    const marker = this._createMarker(latlng);\n    let onClick;\n\n    marker.setOpacity(0.6);\n\n    // eslint-disable-next-line\n    marker1._middleRight = marker2._middleLeft = marker;  // TODO no reassignment\n\n    function onDragStart() {\n      marker.off('touchmove', onDragStart, this);\n      const i = marker2._index;\n\n      marker._index = i;\n\n      marker\n        .off('click', onClick, this)\n        .on('click', this._onMarkerClick, this);\n\n      // $FlowFixMe\n      latlng.lat = marker.getLatLng().lat;\n      // $FlowFixMe\n      latlng.lng = marker.getLatLng().lng;\n      this._spliceLatLngs(i, 0, latlng);\n      this._markers.splice(i, 0, marker);\n\n      marker.setOpacity(1);\n\n      this._updateIndexes(i, 1);\n      // eslint-disable-next-line\n      marker2._index += 1;    // TODO no reassignment\n      PolyVerticesEdit._updatePrevNext(marker1, marker);\n      PolyVerticesEdit._updatePrevNext(marker, marker2);\n\n      this._poly.fire('editstart');\n    }\n\n    function onDragEnd() {\n      marker.off('dragstart', onDragStart, this);\n      marker.off('dragend', onDragEnd, this);\n      marker.off('touchmove', onDragStart, this);\n\n      this._createMiddleMarker(marker1, marker);\n      this._createMiddleMarker(marker, marker2);\n    }\n\n    onClick = () => {\n      onDragStart.call(this);\n      onDragEnd.call(this);\n      this._fireEdit();\n    };\n\n    marker\n      .on('click', onClick, this)\n      .on('dragstart', onDragStart, this)\n      .on('dragend', onDragEnd, this)\n      .on('touchmove', onDragStart, this);\n\n    this._markerGroup.addLayer(marker);\n  }\n\n  static _updatePrevNext(marker1: L.Marker, marker2: L.Marker): void {\n    if (marker1) // eslint-disable-next-line\n      marker1._next = marker2;      // TODO no reassignment\n    if (marker2) // eslint-disable-next-line\n      marker2._prev = marker1;      // TODO no reassignment\n  }\n\n  _getMiddleLatLng(marker1: L.Point, marker2: L.Point): void {\n    const map = this._poly._map;\n    const p1 = map.project(marker1.getLatLng());\n    const p2 = map.project(marker2.getLatLng());\n\n    return map.unproject(p1._add(p2)._divideBy(2));\n  }\n}\n\n\nL.Polyline.addInitHook(function addInit() {\n  // Check to see if handler has already been initialized. This is to support versions of Leaflet\n  // that still have L.Handler.PolyEdit\n  if (this.editing)\n    return;\n\n  if (Poly) {\n    this.editing = new Poly(this, this.options.poly);\n\n    if (this.options.editable) {\n      this.editing.enable();\n    }\n  }\n\n  this.on('add', function onAdd() {\n    if (this.editing && this.editing.enabled()) {\n      this.editing.addHooks();\n    }\n  });\n\n  this.on('remove', function onRemove() {\n    if (this.editing && this.editing.enabled()) {\n      this.editing.removeHooks();\n    }\n  });\n});\n"]}